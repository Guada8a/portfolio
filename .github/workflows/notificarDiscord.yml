name: Discord Notification

on:
  push:
    branches:
      - "*"

jobs:
  send_notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Extract commit information and send Discord message
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "Iniciando script de notificaci√≥n"

          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=format:'%an')
          AUTHOR_USERNAME=$(echo "${{ github.actor }}")
          BRANCH=$(echo ${{ github.ref }} | awk -F'/' '{print $NF}')
          REPO_NAME=$(echo ${{ github.repository }} | awk -F'/' '{print $NF}')
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "Informaci√≥n extra√≠da:"
          echo "Commit Message: $COMMIT_MESSAGE"
          echo "Author: $AUTHOR"
          echo "Branch: $BRANCH"
          echo "Repo Name: $REPO_NAME"

          # Simplificar el payload para depuraci√≥n
          JSON_PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "üìÇ Repositorio: $REPO_NAME",
              "description": "üí¨ $COMMIT_MESSAGE\nüåø \`$BRANCH\`  üë§ $AUTHOR",
              "color": 3447003,
              "footer": {
                "text": "GitHub Actions ‚Ä¢ $TIMESTAMP"
              }
            }]
          }
          EOF
          )

          echo "JSON Payload:"
          echo "$JSON_PAYLOAD"

          echo "Enviando notificaci√≥n a Discord..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Content-Type: application/json" -d "$JSON_PAYLOAD" $DISCORD_WEBHOOK)
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Respuesta de Discord:"
          echo "Estado HTTP: $HTTP_STATUS"
          echo "Cuerpo de la respuesta: $BODY"

          if [ "$HTTP_STATUS" -eq 204 ]; then
            echo "Notificaci√≥n enviada exitosamente"
          else
            echo "Error al enviar la notificaci√≥n"
            exit 1
          fi